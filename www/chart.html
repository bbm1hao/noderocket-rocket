<!DOCTYPE html>
<html>
<head>
  <title>Node Rockets</title>
  <!--<link rel="stylesheet" href="css/rocket.css">-->

  <style>
    body {
      font: 10px sans-serif;
      margin: 0;
      /*background: url(images/black_lozenge.png);*/
      background: #333;
    }

    svg {
      /*background: #6d941b;*/
      background: url(images/tiny_grid.png);
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .x.axis path {
      display: none;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    #graph {
      position: absolute;
      bottom: 0;
    }
  </style>
</head>
<body>

<button onclick="deploy()">Deploy</button>
<button onclick="arm()">Arm</button>

<!--<iframe src="http://192.168.1.101:8080/javascript_simple.html"></iframe>-->

<div id="graph"></div>

<!--<script type="text/javascript" src="/socket.io/socket.io.js"></script>-->
<script type="text/javascript" src="js/lib/d3.min.js"></script>
<script type="text/javascript" src="js/lib/moment.min.js"></script>

<script>
  /*
  var socket = io.connect();

  socket.on('hello', function (d) {
    console.log('Hello Rocket!');
  });


  function deploy() {
    socket.emit('deploy-parachute');
  }

  function arm() {
    socket.emit('arm-parachute');
  }*/

  var data = [];

  var margin = {top: 20, right: 20, bottom: 30, left: 50},
      width = window.innerWidth - margin.left - margin.right,
      height = 250 - margin.top - margin.bottom;

  // Parse the datetime
  //  var parseDate = d3.time.format("%H:%M:%S").parse;

  var xScale = d3.time.scale()
      .range([0, width]);

  var yScale = d3.scale.linear()
      .range([height, 0]);

  var xAxis = d3.svg.axis()
      .scale(xScale)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(yScale)
      .orient("left");

  var line = d3.svg.line()
      .x(function (d) {
        return xScale(d.time);
      })
      .y(function (d) {
        return yScale(d.altitude);
      });

  var svg = d3.select("#graph").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


  data.forEach(function (datum) {
//    datum.time = parseDate(datum.time);
    datum.time = moment(datum.time).toDate();
    datum.altitude = +datum.altitude;
  });

  xScale.domain(d3.extent(data, function (d) {
    return d.time
  }));
  yScale.domain(d3.extent(data, function (d) {
    return d.altitude
  }));

  svg.append('g')
      .attr('class', 'x axis')
      .attr('transform', 'translate(0,' + height + ')')
      .call(xAxis);


  svg.append('g')
      .attr('class', 'y axis')
      .call(yAxis)
      .append('text')
      .attr('transform', 'rotate(-90)')
      .attr('y', 6)
      .attr('dy', ".71em")
      .style('text-anchor', 'end')
      .text('Altitude');


  svg.append('path')
      .datum(data)
      .attr('class', 'line')
      .attr('d', line);


  function updateData() {

    data.forEach(function (datum) {
//    datum.time = parseDate(datum.time);
      datum.time = moment(datum.time).toDate();
      datum.altitude = +datum.altitude;
    });

    xScale.domain(d3.extent(data, function (d) {
      return d.time
    }));
    yScale.domain(d3.extent(data, function (d) {
      return d.altitude
    }));

    var svg = d3.select("body").transition();

    // Make the changes
    svg.select(".line")   // change the line
        .duration(10)
        .attr("d", line(data));
    svg.select(".x.axis") // change the x axis
        .duration(10)
        .call(xAxis);
    svg.select(".y.axis") // change the y axis
        .duration(10)
        .call(yAxis);

  }

  /*
   socket.on('rocket-data', function (d) {
   console.log(d);

   data.push({
   altitude: d.altitude,
   time: new moment()
   });

   data = data.splice(-150);
   updateData();
   });
   */

  setInterval(function () {
    data.push({
      altitude: Math.random() * 2000,
      time: new moment()
    });

    data = data.splice(-150);
    updateData();
  }, 200);

</script>

</body>
</html>
